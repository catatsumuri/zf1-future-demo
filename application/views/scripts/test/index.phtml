<div class="page-header">
    <h1>Database Connectivity Test</h1>
    <p class="text-muted">Verify the application can reach the MySQL service defined in Docker Compose.</p>
</div>

<?php if ($this->isConnected): ?>
    <div class="alert alert-success" role="alert">
        <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
        <?php echo $this->escape($this->message); ?>
    </div>
    <dl class="dl-horizontal">
        <dt>MySQL Version</dt>
        <dd><?php echo $this->escape($this->version); ?></dd>
    </dl>
<?php else: ?>
    <div class="alert alert-danger" role="alert">
        <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
        <?php echo $this->escape($this->message); ?>
    </div>
    <?php if (isset($this->error)): ?>
        <div class="alert alert-warning" role="alert">
            <strong>Error detail:</strong>
            <pre style="margin: 8px 0 0; background: transparent; border: 0; padding: 0;"><?php echo $this->escape($this->error); ?></pre>
        </div>
    <?php endif; ?>
<?php endif; ?>

<p class="text-muted">Provide credentials through environment variables such as <code>DB_HOST</code>, <code>DB_USER</code>, <code>DB_PASSWORD</code>, and <code>DB_NAME</code> before starting the stack.</p>

<?php
$connectionParams = $this->connectionParams ?? [];

if (!empty($connectionParams)) {
    $sortedConnectionParams = $connectionParams;
    ksort($sortedConnectionParams);
}

$environmentVariables = $this->environmentVariables ?? [];

if (!empty($environmentVariables)) {
    ksort($environmentVariables);
}

$sessionTrace = $this->sessionTrace ?? [];
$configuredSessionOptions = [];
$runtimeSessionOptions = [];
$sessionHandler = [];

if (isset($sessionTrace['configured']) && is_array($sessionTrace['configured'])) {
    $configuredSessionOptions = $sessionTrace['configured'];
}

if (isset($sessionTrace['runtime']) && is_array($sessionTrace['runtime'])) {
    $runtimeSessionOptions = $sessionTrace['runtime'];
}

if (isset($sessionTrace['handler']) && is_array($sessionTrace['handler'])) {
    $sessionHandler = $sessionTrace['handler'];
}

if (!function_exists('__test_flatten_options')) {
    function __test_flatten_options(array $values, string $prefix = ''): array
    {
        $flattened = [];

        foreach ($values as $key => $value) {
            $path = $prefix === '' ? (string) $key : $prefix . '.' . $key;

            if (is_array($value)) {
                $flattened += __test_flatten_options($value, $path);
            } else {
                $flattened[$path] = $value;
            }
        }

        return $flattened;
    }
}

$configuredSessionOptions = __test_flatten_options($configuredSessionOptions);
$runtimeSessionOptions = __test_flatten_options($runtimeSessionOptions);

if (!empty($configuredSessionOptions)) {
    ksort($configuredSessionOptions);
}

if (!empty($runtimeSessionOptions)) {
    ksort($runtimeSessionOptions);
}
?>

<?php if (!empty($connectionParams)): ?>
    <h2>Connection Parameters</h2>
    <table class="table table-striped table-bordered table-condensed">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
        <?php foreach ($sortedConnectionParams as $key => $value): ?>
            <tr>
                <td><?php echo $this->escape($key); ?></td>
                <td><code><?php echo $this->escape((string) $value); ?></code></td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
<?php endif; ?>

<?php if (!empty($environmentVariables)): ?>
    <h2>Environment Variables</h2>
    <table class="table table-striped table-bordered table-condensed">
        <thead>
            <tr>
                <th>Name</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
        <?php foreach ($environmentVariables as $name => $value): ?>
            <tr>
                <td><?php echo $this->escape($name); ?></td>
                <td><code><?php echo $this->escape((string) $value); ?></code></td>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
<?php endif; ?>

<?php if (!empty($sessionTrace)): ?>
    <h2>Session Diagnostics</h2>

    <?php if (!empty($configuredSessionOptions)): ?>
        <h3>Configured Options (`application.ini`)</h3>
        <table class="table table-striped table-bordered table-condensed">
            <thead>
                <tr>
                    <th>Option</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
            <?php foreach ($configuredSessionOptions as $option => $value): ?>
                <tr>
                    <td><?php echo $this->escape($option); ?></td>
                    <td><code><?php echo $this->escape((string) $value); ?></code></td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>

    <?php if (!empty($runtimeSessionOptions)): ?>
        <h3>Runtime Options (`Zend_Session::getOptions()`)</h3>
        <table class="table table-striped table-bordered table-condensed">
            <thead>
                <tr>
                    <th>Option</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
            <?php foreach ($runtimeSessionOptions as $option => $value): ?>
                <tr>
                    <td><?php echo $this->escape($option); ?></td>
                    <td><code><?php echo $this->escape((string) $value); ?></code></td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>

    <h3>Save Handler</h3>
    <dl class="dl-horizontal">
        <dt>Status</dt>
        <dd><?php echo $this->escape($sessionHandler['status'] ?? 'unknown'); ?></dd>

        <?php if (isset($sessionHandler['class'])): ?>
            <dt>Class</dt>
            <dd><code><?php echo $this->escape((string) $sessionHandler['class']); ?></code></dd>
        <?php endif; ?>

        <?php if (isset($sessionHandler['message'])): ?>
            <dt>Message</dt>
            <dd><?php echo $this->escape((string) $sessionHandler['message']); ?></dd>
        <?php endif; ?>
    </dl>

    <?php if (isset($sessionHandler['driver']) && is_array($sessionHandler['driver'])): ?>
        <?php $driver = $sessionHandler['driver']; ?>
        <table class="table table-striped table-bordered table-condensed">
            <thead>
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($driver as $property => $value): ?>
                    <tr>
                        <td><?php echo $this->escape($property); ?></td>
                        <td><code><?php echo $this->escape(is_scalar($value) || $value === null ? (string) $value : json_encode($value, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES)); ?></code></td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php endif; ?>
<?php endif; ?>
